from telegrambot import parse_addon
import json
from telegrambot import load_parameters
params = load_parameters()
#import pdb;pdb.set_trace()
params = params['781665670']
params['undergrounds'] = [".*"]
#with open("desc_bench_new.json", "r", encoding='utf-8') as final:
    #loaded = json.load(final)
"""
for i in loaded[25:]:
    
    addon = i[1][0]
    #if any("Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº" in a for a in addon['Ñ‚Ð¸Ð¿ Ñ€Ð°Ð·Ñ‹ÑÐºÐ¸Ð²Ð°ÐµÐ¼Ð¾Ð³Ð¾ Ð¶Ð¸Ð»ÑŒÑ†Ð°']) or addon['Ð¸Ñ‰ÑƒÑ‚ Ð»Ð¸ ÑÐµÐ¼ÐµÐ¹Ð½ÑƒÑŽ Ð¿Ð°Ñ€Ñƒ'] == 'Ð´Ð°':
    
    d = []
    
    try:
            
            print(111111111111)
            print(i)
            a = parse_addon(i[1], params)
            print(a)
            print(i[0])
            #d.append(i[1])
    except:
        pass       
 
    #for j in i[1]:
    #    print(j)
        #parse_addon()
        """
addon = [{'ÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð»ÑŽÐ´ÐµÐ¹ Ð¶Ð¸Ð²Ñ‘Ñ‚ Ð² Ð½Ð°ÑÑ‚Ð¾ÑÑ‰Ð¸Ð¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚ Ð² ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€Ðµ?': 0, 'ÐºÑ‚Ð¾ Ð¶Ð¸Ð²Ñ‘Ñ‚ Ð² Ð½Ð°ÑÑ‚Ð¾ÑÑ‰Ð¸Ð¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚': {'Ð½Ð¸ÐºÑ‚Ð¾': []}, 'Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ': 'ÑÑ‚Ñ€Ð¾Ð³Ð¾', 'Ð¼Ð¾Ð¶Ð½Ð¾ Ð»Ð¸ Ð·Ð°ÑÐµÐ»Ð¸Ñ‚ÑŒÑÑ Ñ Ð¶Ð¸Ð²Ð¾Ñ‚Ð½Ñ‹Ð¼Ð¸': 'Ð½ÐµÑ‚', 'Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð»Ð¸ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ð°': 'Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾', 'ÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÐºÐ¾Ð¼Ð½Ð°Ñ‚ Ð² ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€Ðµ': 2, 'Ð¸Ñ‰ÑƒÑ‚ Ð»Ð¸ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ°': 'Ð½ÐµÑ‚', 'Ð¸Ñ‰ÑƒÑ‚ Ð»Ð¸ Ð´Ð²ÑƒÑ… Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº': 'Ð½ÐµÑ‚', 'Ð¸Ñ‰ÑƒÑ‚ Ð»Ð¸ Ð¾Ð´Ð½Ñƒ Ð¶ÐµÐ½Ñ‰Ð¸Ð½Ñƒ/Ð´ÐµÐ²ÑƒÑˆÐºÑƒ': 'Ð´Ð°', 'Ð¸Ñ‰ÑƒÑ‚ Ð»Ð¸ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¼ÑƒÐ¶Ñ‡Ð¸Ð½Ñƒ/Ð¿Ð°Ñ€Ð½Ñ': 'Ð½ÐµÑ‚', 'Ð¸Ñ‰ÑƒÑ‚ Ð»Ð¸ Ð¿Ð°Ñ€Ñƒ Ð¸Ð· Ð¼ÑƒÐ¶Ñ‡Ð¸Ð½Ñ‹ Ð¸ Ð¶ÐµÐ½Ñ‰Ð¸Ð½Ñ‹': 'Ð½ÐµÑ‚', 'Ð¸Ñ‰ÑƒÑ‚ Ð»Ð¸ Ð¿Ð°Ñ€Ñƒ Ð¶ÐµÐ½Ñ‰Ð¸Ð½/Ð´ÐµÐ²ÑƒÑˆÐµÐº': 'Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾', 'Ð¸Ñ‰ÑƒÑ‚ Ð»Ð¸ Ð¿Ð°Ñ€Ñƒ Ð¼ÑƒÐ¶Ñ‡Ð¸Ð½/Ð¿Ð°Ñ€Ð½ÐµÐ¹': 'Ð½ÐµÑ‚'}]
addon =  [
                {
                  "post_id": "norealtor/10302",
                  "text": "\nÐ¥ÐÐ¢Ð Ð¡ÐÐ¯Ð¢Ð | ÐÑ€ÐµÐ½Ð´Ð° Ð¶Ð¸Ð»ÑŒÑ ÐœÐ¾ÑÐºÐ²Ð° | Ð¡Ð½ÑÑ‚ÑŒ ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€Ñƒ\nÐ¡Ð´Ð°Ð¼ ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€Ñƒ-ÑÑ‚ÑƒÐ´Ð¸ÑŽ 27Ð¼2Ðœ. ÐÐ¸Ð¶ÐµÐ³Ð¾Ñ€Ð¾Ð´ÑÐºÐ°Ñ, ÑƒÐ». Ð“Ð°Ð·Ð³Ð¾Ð»ÑŒÐ´ÐµÑ€Ð½Ð°Ñ Ð´. 1043 000 Ñ€ÑƒÐ±/Ð¼ÐµÑ â€” ÐœÐ°Ñ€Ð¸Ð½Ð°CÐ´aeÑ‚cÑ ÐºÐ²aÑ€Ñ‚Ð¸Ñ€a -ÑÑ‚ÑƒÐ´Ð¸Ñ  ÐºÐ¾Ð¼Ñ„Ð¾Ñ€Ñ‚-ÐºÐ»aÑcÐ° Ð–K Profit c ÐµÐ²pÐ¾peÐ¼oÐ½Ñ‚oÐ¼. KÐ²aÑ€Ñ‚Ð¸Ñ€Ð° Ð½Ðµ ÑƒÐºoÐ¼Ð¿Ð»ÐµÐºÑ‚Ð¾Ð²aÐ½Ð° Ð´o ÐºÐ¾Ð½Ñ†Ð°, Ð¿Ð¾ÑÑ‚Ð¾Ð¼Ñƒ Ñ†ÐµÐ½Ð° Ð½Ð° Ð¿epÐ²Ñ‹Ð¹ Ð¼eÑÑÑ† 43 000, Ð´Ð°Ð»ee 55 000. ÐŸÑ€eÐ´Ð»Ð¾Ð¶eÐ½Ð¸e oÑ‚ coÐ±cÑ‚Ð²ÐµÐ½Ð½Ð¸ÐºÐ°, Ð±ÐµÐ· ÐºÐ¾Ð¼Ð¸ccÐ¸Ð¹.Ð£Ð´oÐ±Ð½Ð¾Ðµ Ñ‚Ñ€Ð°cÐ¿oÑ€Ñ‚Ð½Ð¾Ðµ pÐ°cÐ¿oÐ»oÐ¶ÐµÐ½Ð¸Ðµ Ð¼. HÐ¸Ð¶ÐµÐ³Ð¾pÐ¾Ð´cÐºaÑ, Ð‘ÐšÐ› , MÐ¦Ð”-4 . Ð Ð°Ð·Ð²Ð¸Ñ‚Ð°Ñ Ð¸Ð½Ñ„Ñ€Ð°ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° , Ð°Ð¿Ñ‚ÐµÐºÐ¸ , Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ñ‹, Ð¢Ð¦. ÐŸÐ¾ÐºÐ°Ð· ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€Ñ‹ Ð¿Ð¾ Ð¿Ñ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸: 18 Ð¸ 19 Ñ„ÐµÐ²Ñ€Ð°Ð»Ñ.Ð‘ÐµÐ· Ð¶Ð¸Ð²Ð¾Ñ‚Ð½Ñ‹Ñ….ÐÐ³ÐµÐ½Ñ‚Ð°Ð¼ Ð¿Ñ€Ð¾ÑˆÑƒ Ð½Ðµ Ð±ÐµÑÐ¿Ð¾ÐºÐ¾Ð¸Ñ‚ÑŒ.#Ð½ÐµÐ´Ð¾Ñ€Ð¾Ð³Ð°ÑÑ…Ð°Ñ‚Ð°\n2.8K views21:19\n",
                  "link": "https://t.me/norealtor/10302?single",
                  "addon": [
                        {
                              "ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ñ": "ÑÐ´Ð°Ñ‡Ð° ÑÑ‚ÑƒÐ´Ð¸Ð¸",
                              "ÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð»ÑŽÐ´ÐµÐ¹ Ð¶Ð¸Ð²Ñ‘Ñ‚ Ð² Ð½Ð°ÑÑ‚Ð¾ÑÑ‰Ð¸Ð¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚ Ð² ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€Ðµ?": "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾",
                              "ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¼ÐµÑÑÑ‡Ð½Ð¾Ð¹ Ð°Ñ€ÐµÐ½Ð´Ñ‹": 43000,
                              "ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð·Ð°Ð»Ð¾Ð³Ð°/ÐºÐ¾Ð¼Ð¸ÑÑÐ¸Ð¸": "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾",
                              "ÐºÑ‚Ð¾ Ð¶Ð¸Ð²Ñ‘Ñ‚ Ð² Ð½Ð°ÑÑ‚Ð¾ÑÑ‰Ð¸Ð¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚": {
                                    "Ð½Ð¸ÐºÑ‚Ð¾": []
                              },
                              "Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ": "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾",
                              "Ð¼Ð¾Ð¶Ð½Ð¾ Ð»Ð¸ Ð·Ð°ÑÐµÐ»Ð¸Ñ‚ÑŒÑÑ Ñ Ð¶Ð¸Ð²Ð¾Ñ‚Ð½Ñ‹Ð¼Ð¸": "Ð½ÐµÑ‚",
                              "Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð»Ð¸ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ð°": "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾",
                              "ÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÐºÐ¾Ð¼Ð½Ð°Ñ‚ Ð² ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€Ðµ": "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾",
                              "Ð¸Ñ‰ÑƒÑ‚ Ð»Ð¸ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ°": "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾",
                              "Ð¸Ñ‰ÑƒÑ‚ Ð»Ð¸ Ð´Ð²ÑƒÑ… Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº": "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾",
                              "Ð¸Ñ‰ÑƒÑ‚ Ð»Ð¸ Ð¾Ð´Ð½Ñƒ Ð¶ÐµÐ½Ñ‰Ð¸Ð½Ñƒ/Ð´ÐµÐ²ÑƒÑˆÐºÑƒ": "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾",
                              "Ð¸Ñ‰ÑƒÑ‚ Ð»Ð¸ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¼ÑƒÐ¶Ñ‡Ð¸Ð½Ñƒ/Ð¿Ð°Ñ€Ð½Ñ": "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾",
                              "Ð¸Ñ‰ÑƒÑ‚ Ð»Ð¸ Ð¿Ð°Ñ€Ñƒ Ð¸Ð· Ð¼ÑƒÐ¶Ñ‡Ð¸Ð½Ñ‹ Ð¸ Ð¶ÐµÐ½Ñ‰Ð¸Ð½Ñ‹": "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾",
                              "Ð¸Ñ‰ÑƒÑ‚ Ð»Ð¸ Ð¿Ð°Ñ€Ñƒ Ð¶ÐµÐ½Ñ‰Ð¸Ð½/Ð´ÐµÐ²ÑƒÑˆÐµÐº": "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾",
                              "Ð¸Ñ‰ÑƒÑ‚ Ð»Ð¸ Ð¿Ð°Ñ€Ñƒ Ð¼ÑƒÐ¶Ñ‡Ð¸Ð½/Ð¿Ð°Ñ€Ð½ÐµÐ¹": "Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾",
                              "ÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð»ÑŽÐ´ÐµÐ¹ Ð¶Ð¸Ð²ÐµÑ‚ Ð² Ð½Ð°ÑÑ‚Ð¾ÑÑ‰Ð¸Ð¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚ Ð² ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€Ðµ": 0
                        }
                  ],
                  "good_description": "ÐšÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ñ: ÑÐ´Ð°Ñ‡Ð° ÑÑ‚ÑƒÐ´Ð¸Ð¸\n\nÐšÐ¾Ð³Ð¾ Ð¸Ñ‰ÑƒÑ‚: Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾  \nÐÐ° ÐºÐ°ÐºÐ¾Ð¹ ÑÑ€Ð¾Ðº: Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾  \nÐœÐ¾Ð¶Ð½Ð¾ Ñ Ð¶Ð¸Ð²Ð¾Ñ‚Ð½Ñ‹Ð¼Ð¸: Ð½ÐµÑ‚  \nÐšÑ‚Ð¾ Ð¶Ð¸Ð²ÐµÑ‚ Ð² ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€Ðµ: Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾  \nÐœÐµÑ‚Ñ€Ð¾: Ð¼. ÐÐ¸Ð¶ÐµÐ³Ð¾Ñ€Ð¾Ð´ÑÐºÐ°Ñ  \nÐ Ð°ÑÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð´Ð¾ Ð¼ÐµÑ‚Ñ€Ð¾: Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾  \nÐ—Ð°Ð»Ð¾Ð³: Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾  \nÐ¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¼ÐµÑÑÑ‡Ð½Ð¾Ð¹ Ð°Ñ€ÐµÐ½Ð´Ñ‹: Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð¼ÐµÑÑÑ† 43 000 Ñ€ÑƒÐ±, Ð´Ð°Ð»ÐµÐµ 55 000 Ñ€ÑƒÐ±  "
            }
                  ]
                  
import pdb;
pdb.set_trace()
from telegrambot import filter_ads_tg, send_old_ads, load_ads, filter_ads
from datetime import datetime

dont_flag = True
ads_to_filter = {}
ads = load_ads()
do_flag = False
for segment in ads:
      for ad in ads[segment][-100:]:  
            if 'addon' in ad or (ad['rooms_count'] > 0):
                  if segment not in ads_to_filter:
                        ads_to_filter[segment] = []
                        ads_to_filter[segment] = ads_to_filter[segment] + [ad]
filtered_ads = {}
for ads_segment in ads_to_filter:
      filtered_ads[ads_segment] = filter_ads(ads_to_filter[ads_segment], params)
for ads_segment in filtered_ads:
      count = 0
      for ad in filtered_ads[ads_segment][-100:]:
            msg = f"""{ad['title']}
      ðŸš‡Ð¼ÐµÑ‚Ñ€Ð¾: {ad['underground']} {ad['metro_dist']}
      ðŸ§â€â™‚ï¸Ð°Ð²Ñ‚Ð¾Ñ€: {ad['author_type']}
      ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÐºÐ¾Ð¼Ð½Ð°Ñ‚: {ad['rooms_count']}
      ðŸ’¸Ñ†ÐµÐ½Ð°: {ad['price_per_month']}â‚½
      ðŸ˜Ñ€Ð°Ð¹Ð¾Ð½: {ad['district']}
      ðŸ”—Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº: {ad['url']}\n
"""
      if 'addon' in ad :
            parsed_addon = parse_addon(ad['addon'], params=params, good_description=ad['good_description'])
            msg = msg + parsed_addon  
                  #  import pdb; pdb.set_trace()
      else:
            parsed_addon = " "
      
      if parsed_addon != " " or (ad['rooms_count'] > 0):
            print(msg)
            count = count + 1 
            do_flag = True
      if count > 3 or (datetime.strptime(ad['time'], '%Y-%m-%d  %H-%M-%S') - datetime.now()).days > 10:
            break
if do_flag:
      
      print(132)
else:
      dont_flag = dont_flag + 1
      if dont_flag > 0:   
            params['author_type'] = "Ð›ÑŽÐ±Ð¾Ð¹"
      if dont_flag > 1:
            params['rooms'][0]['max_price'] = params['rooms'][0]['max_price'] + 2500
      if dont_flag > 3:
            params['undergrounds'] = ".*"
      if dont_flag > 4:
            print(132)
      